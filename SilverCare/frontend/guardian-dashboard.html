<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Dashboard - SilverCare</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SilverCare">
    <meta name="description" content="SilverCare Guardian Dashboard - Monitor elderly health and safety">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMwMDdBRkYiLz4KPHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI0OCIgeT0iNDgiPgo8cGF0aCBkPSJNMjggNDBIMjhWNTZINDhWNDBIMjh6IiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNDggNDBINjhWNTZINDhWNDBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNpbHZlckNhcmUiLAogICJzaG9ydF9uYW1lIjogIlNpbHZlckNhcmUiLAogICJzdGFydF91cmwiIjogImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9ndWFyZGlhbi1kYXNoYm9hcmQuaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDdBRkYiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlpXMWlabk1sY21sa1pTSTZJblI1YXkxdmNHVnlZWFJ2Y2s5cFpDNWtiM2N1Wkc5amFXRmtaVjl0WVhOMFpYSXVZMjl0Wlc1MGNHeGxMbU52YlM5MmFXUmxieTVzTjJOMFlXNTBjR3hsTG1OdmJTOXVjR1Y2WVdSMWN5NWhiV1U2YzJsdmNHVnlYMlJ2YXkxdmNHVnlZWFJ2Y2s5cFpDNWtiM2N1Wkc5amFXRmtaVjl0WVhOMFpYSXVZMjl0Wlc1MGNHeGxMbU52YlM5MmFXUmxieTVzTjJOMFlXNTBjR3hsTG1OdmJTOXVjR1Y2WVdSMWN5NWhiV1U2YzJsdmNHVnlYMlJ2YXkxdmNHVnlZWFJ2Y2s5cFpDNWtiM2N1Wkc5amFXRmtaVjl0WVhOMFpYSXVZMjl0Wlc1MGNHeGxMbU52YlM5MmFXUmxieTVzTjJOMFlXNTBjR3hsTG1OdmJTOXVjR1Y2WVdSMWN5NWhiV1U2YzJsdmNHVnlYMlJ2YXkxdmNHVnlZWFJ2Y2s5cFpDNWtiM2N1Wkc5amFXRmtaVjl0WVhOMFpYSXVZMjl0Wlc1MGNHeGxMbU52YlM5MmFXUmxieTVzTjJOMFlXNTBjR3hsTG1OdmJTOXVjR1Y2WVdSMWN5NWhiV1U2YzJsdmNHVnlYMlJ2IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2sibGUiCiAgICB9CiAgXQp9">
    <style>
        body {
            background: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        * {
            box-sizing: border-box;
        }

        .dashboard-container {
            width: 100%;
            max-width: 375px;
            margin: 0 auto;
            padding: 0;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #ffffff;
            border-radius: 0;
            padding: 16px;
            margin-bottom: 0;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e7;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .guardian-info h1 {
            color: #000000;
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
        }

        .guardian-info p {
            color: #6c6c70;
            margin: 2px 0 0 0;
            font-size: 14px;
            font-weight: 400;
        }

        .logout-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.15s ease;
            min-height: 36px;
            min-width: 80px;
        }

        .logout-btn:hover {
            background: #d70015;
            transform: scale(0.95);
        }

        .logout-btn:active {
            transform: scale(0.9);
        }

        .elderly-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 0;
            flex: 1;
            padding-bottom: 20px;
        }

        .elderly-card {
            background: #ffffff;
            border-radius: 0;
            padding: 16px;
            box-shadow: none;
            transition: all 0.15s ease;
            border-bottom: 1px solid #e5e5e7;
            position: relative;
            cursor: pointer;
        }

        .elderly-card:hover {
            background: #f2f2f7;
        }

        .elderly-card:active {
            background: #e5e5ea;
            transform: scale(0.98);
        }

        .elderly-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .elderly-avatar {
            width: 48px;
            height: 48px;
            background: #007AFF;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .elderly-name {
            font-size: 17px;
            font-weight: 600;
            color: #000000;
            margin: 0;
            line-height: 1.3;
        }

        .elderly-age {
            color: #6c6c70;
            font-size: 14px;
            margin: 2px 0 0 0;
            font-weight: 400;
        }

        .info-section {
            margin-bottom: 12px;
        }

        .info-label {
            font-weight: 500;
            color: #6c6c70;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            color: #000000;
            font-size: 15px;
            font-weight: 400;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-safe {
            background: #e8f5e8;
            color: #34c759;
        }

        .status-alert {
            background: #fff3cd;
            color: #ff9500;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-secondary {
            background: #f2f2f7;
            color: #007AFF;
            border: 1px solid #d1d1d6;
        }

        .btn:hover {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .btn:active {
            transform: scale(0.9);
        }

        .no-elderly {
            background: #ffffff;
            border-radius: 0;
            padding: 60px 20px;
            text-align: center;
            box-shadow: none;
            margin: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .no-elderly h2 {
            color: #000000;
            margin-bottom: 12px;
            font-size: 24px;
            font-weight: 700;
        }

        .no-elderly p {
            color: #6c6c70;
            margin-bottom: 24px;
            font-size: 16px;
            line-height: 1.5;
            max-width: 300px;
        }

        .add-elderly-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 24px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 50px;
            min-width: 200px;
        }

        .add-elderly-btn:hover {
            background: #0056b3;
            transform: scale(0.95);
        }

        .add-elderly-btn:active {
            transform: scale(0.9);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c6c70;
            font-size: 16px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Ensure mobile viewport */
        @viewport {
            width: device-width;
            initial-scale: 1.0;
            maximum-scale: 1.0;
            user-scalable: no;
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .header {
                padding-top: env(safe-area-inset-top);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="guardian-info">
                <h1 id="guardianName">Loading...</h1>
                <p id="guardianContact">Loading...</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            Loading your dashboard...
        </div>

        <!-- No Elderly State -->
        <div id="noElderlyState" class="no-elderly" style="display: none;">
            <h2>No Elderly Members Linked Yet</h2>
            <p>You haven't linked any elderly members to your account yet. Ask them to register using your username and password.</p>
            <button class="add-elderly-btn" onclick="showRegistrationInstructions()">
                View Registration Instructions
            </button>
        </div>

        <!-- Elderly Grid -->
        <div id="elderlyGrid" class="elderly-grid" style="display: none;">
            <!-- Elderly cards will be dynamically added here -->
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:5001";

        // Load guardian info from localStorage
        function loadGuardianInfo() {
            const guardianName = localStorage.getItem('guardian_name');
            const guardianPhone = localStorage.getItem('guardian_phone');
            const guardianEmail = localStorage.getItem('guardian_email');
            const guardianUsername = localStorage.getItem('guardian_username');

            if (!guardianUsername) {
                window.location.href = 'guardian-auth.html';
                return;
            }

            document.getElementById('guardianName').textContent = guardianName || 'Guardian';
            document.getElementById('guardianContact').textContent = 
                guardianPhone ? `üìû ${guardianPhone}` : guardianEmail ? `‚úâÔ∏è ${guardianEmail}` : 'No contact info';

            return guardianUsername;
        }

        // Fetch linked elderly members
        async function fetchLinkedElderly(guardianUsername) {
            try {
                const response = await fetch(`${API_BASE}/guardian-elderly/${guardianUsername}`);
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    displayElderly(data.data || []);
                } else {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('noElderlyState').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching elderly:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('noElderlyState').style.display = 'block';
            }
        }

        // Display elderly cards
        function displayElderly(elderlyList) {
            document.getElementById('loadingState').style.display = 'none';

            if (elderlyList.length === 0) {
                document.getElementById('noElderlyState').style.display = 'block';
                return;
            }

            const grid = document.getElementById('elderlyGrid');
            grid.innerHTML = '';
            grid.style.display = 'grid';

            elderlyList.forEach(elderly => {
                const card = createElderlyCard(elderly);
                grid.appendChild(card);
            });
        }

        // Create elderly card
        function createElderlyCard(elderly) {
            const card = document.createElement('div');
            card.className = 'elderly-card';

            const initials = elderly.name.split(' ').map(n => n[0]).join('').toUpperCase();

            card.innerHTML = `
                <div class="elderly-header">
                    <div class="elderly-avatar">${initials}</div>
                    <div>
                        <h3 class="elderly-name">${elderly.name}</h3>
                        <p class="elderly-age">Age: ${elderly.age || 'Not specified'}</p>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-label">Status</div>
                    <span class="status-indicator status-safe">Safe</span>
                </div>

                ${elderly.phone ? `
                <div class="info-section">
                    <div class="info-label">Phone</div>
                    <div class="info-value">üìû ${elderly.phone}</div>
                </div>
                ` : ''}

                ${elderly.location ? `
                <div class="info-section">
                    <div class="info-label">Location</div>
                    <div class="info-value">üìç ${elderly.location}</div>
                </div>
                ` : ''}

                ${elderly.medical_history ? `
                <div class="info-section">
                    <div class="info-label">Medical History</div>
                    <div class="info-value">${elderly.medical_history}</div>
                </div>
                ` : ''}

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="viewDetails('${elderly.elderly_id}')">
                        View Details
                    </button>
                    <button class="btn btn-secondary" onclick="checkAlerts('${elderly.elderly_id}')">
                        Check Alerts
                    </button>
                    <button class="btn btn-primary" onclick="manageMedicines('${elderly.elderly_id}', '${elderly.name}')">
                        üíä Medicines
                    </button>
                    <button class="btn btn-secondary" onclick="addSuggestion('${elderly.elderly_id}', '${elderly.name}')">
                        üìù Add Suggestion
                    </button>
                </div>
            `;

            return card;
        }

        // View elderly details
        function viewDetails(elderlyId) {
            showElderlyDetailsModal(elderlyId);
        }

        // Check alerts
        function checkAlerts(elderlyId) {
            alert(`Alerts for ${elderlyId} - Coming soon!`);
        }

        // Manage medicines
        function manageMedicines(elderlyId, elderlyName) {
            showMedicineModal(elderlyId, elderlyName);
        }

        // Add suggestion
        function addSuggestion(elderlyId, elderlyName) {
            const suggestion = prompt(`Enter health suggestion for ${elderlyName}:`);
            if (suggestion && suggestion.trim()) {
                submitSuggestion(elderlyId, suggestion.trim());
            }
        }

        // Show elderly details modal
        function showElderlyDetailsModal(elderlyId) {
            const modalHtml = `
                <div id="elderlyDetailsModal" class="modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    padding: 20px;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 20px;
                        padding: 0;
                        max-width: 375px;
                        width: 100%;
                        max-height: 90vh;
                        overflow-y: auto;
                        animation: slideUp 0.3s ease-out;
                        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
                    ">
                        <div style="
                            background: white;
                            padding: 20px 16px;
                            border-bottom: 1px solid #e5e5e7;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                            border-radius: 20px 20px 0 0;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="color: #000000; margin: 0; font-size: 20px; font-weight: 700;">üìä Health Dashboard</h3>
                                <button onclick="closeElderlyDetailsModal()" style="
                                    background: none;
                                    border: none;
                                    font-size: 24px;
                                    color: #6c6c70;
                                    cursor: pointer;
                                    padding: 4px;
                                    line-height: 1;
                                    min-width: 32px;
                                    min-height: 32px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border-radius: 16px;
                                ">√ó</button>
                            </div>
                        </div>
                        
                        <div style="padding: 16px;">
                            <!-- Summary Cards -->
                            <div id="summaryCards" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                                <div style="background: linear-gradient(135deg, #34c759, #32d74b); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                                    <h4 style="margin: 0; font-size: 20px; font-weight: 600;" id="takenCount">-</h4>
                                    <p style="margin: 4px 0 0 0; font-size: 13px;">Taken</p>
                                </div>
                                <div style="background: linear-gradient(135deg, #ff3b30, #ff6961); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                                    <h4 style="margin: 0; font-size: 20px; font-weight: 600;" id="missedCount">-</h4>
                                    <p style="margin: 4px 0 0 0; font-size: 13px;">Missed</p>
                                </div>
                                <div style="background: linear-gradient(135deg, #ff9500, #ffcc02); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                                    <h4 style="margin: 0; font-size: 20px; font-weight: 600;" id="adherenceRate">-</h4>
                                    <p style="margin: 4px 0 0 0; font-size: 13px;">Score</p>
                                </div>
                                <div style="background: linear-gradient(135deg, #007AFF, #5ac8fa); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                                    <h4 style="margin: 0; font-size: 20px; font-weight: 600;" id="totalMedicines">-</h4>
                                    <p style="margin: 4px 0 0 0; font-size: 13px;">Medicines</p>
                                </div>
                            </div>
                            
                            <!-- Monthly Calendar View -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #000000; margin-bottom: 12px; font-size: 18px; font-weight: 600;">üìÖ This Month</h4>
                                <div id="calendarView" style="background: #f2f2f7; padding: 16px; border-radius: 12px;">
                                    <p style="color: #6c6c70; text-align: center;">Loading calendar...</p>
                                </div>
                            </div>
                            
                            <!-- Medicine Schedule -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #000000; margin-bottom: 12px; font-size: 18px; font-weight: 600;">üíä Medicines</h4>
                                <div id="medicineSchedule" style="max-height: 250px; overflow-y: auto;">
                                    <p style="color: #6c6c70; text-align: center;">Loading schedule...</p>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #000000; margin-bottom: 12px; font-size: 18px; font-weight: 600;">üìà Recent Activity</h4>
                                <div id="recentActivity" style="background: #f2f2f7; padding: 16px; border-radius: 12px; max-height: 180px; overflow-y: auto;">
                                    <p style="color: #6c6c70; text-align: center;">Loading activity...</p>
                                </div>
                            </div>
                            
                            <button onclick="refreshElderlyDetails('${elderlyId}')" style="
                                background: #007AFF;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 24px;
                                font-size: 16px;
                                font-weight: 500;
                                cursor: pointer;
                                width: 100%;
                                min-height: 48px;
                                margin-bottom: 16px;
                            ">üîÑ Refresh</button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes slideUp {
                        from {
                            transform: translateY(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    
                    .modal-overlay {
                        backdrop-filter: blur(10px);
                    }
                    
                    @media (max-width: 400px) {
                        #elderlyDetailsModal .modal-content {
                            max-width: 100%;
                            margin: 0 10px;
                        }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            loadElderlyDetails(elderlyId);
            
            // Close modal when clicking outside
            document.getElementById('elderlyDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeElderlyDetailsModal();
                }
            });
        }

        // Load elderly details
        async function loadElderlyDetails(elderlyId) {
            try {
                // Load medicines
                const medicinesResponse = await fetch(`${API_BASE}/medicines/${elderlyId}`);
                const medicinesData = await medicinesResponse.json();
                const medicines = medicinesData.medicines || [];
                
                // Load elderly info
                const elderlyResponse = await fetch(`${API_BASE}/elderly-info/${elderlyId}`);
                const elderlyData = await elderlyResponse.json();
                const elderly = elderlyData.data || {};
                
                // Calculate statistics
                const stats = calculateMedicineStats(medicines);
                
                // Update summary cards
                document.getElementById('takenCount').textContent = stats.taken;
                document.getElementById('missedCount').textContent = stats.missed;
                document.getElementById('adherenceRate').textContent = stats.adherenceRate + '%';
                document.getElementById('totalMedicines').textContent = medicines.length;
                
                // Generate calendar view
                generateCalendarView(medicines);
                
                // Display medicine schedule
                displayMedicineSchedule(medicines);
                
                // Display recent activity
                displayRecentActivity(medicines);
                
            } catch (error) {
                console.error('Error loading elderly details:', error);
                document.getElementById('summaryCards').innerHTML = '<p style="color: #dc3545; text-align: center;">Error loading data</p>';
            }
        }

        // Calculate medicine statistics
        function calculateMedicineStats(medicines) {
            let taken = 0;
            let missed = 0;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            medicines.forEach(medicine => {
                if (medicine.confirmation_history) {
                    medicine.confirmation_history.forEach(record => {
                        const recordDate = new Date(record.timestamp);
                        if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                            if (record.taken) {
                                taken++;
                            } else {
                                missed++;
                            }
                        }
                    });
                }
            });
            
            const total = taken + missed;
            const adherenceRate = total > 0 ? Math.round((taken / total) * 100) : 0;
            
            return { taken, missed, adherenceRate, total };
        }

        // Generate calendar view
        function generateCalendarView(medicines) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHtml = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 11px;">
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">S</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">M</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">T</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">W</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">T</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">F</div>
                    <div style="font-weight: 600; color: #86868b; padding: 4px;">S</div>
            `;
            
            const firstDay = new Date(year, month, 1).getDay();
            for (let i = 0; i < firstDay; i++) {
                calendarHtml += '<div></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayStats = getDayMedicineStats(medicines, date);
                const bgColor = dayStats.adherenceRate >= 80 ? '#34c759' : 
                              dayStats.adherenceRate >= 50 ? '#ff9500' : '#ff3b30';
                const isToday = date.toDateString() === now.toDateString();
                
                calendarHtml += `
                    <div style="
                        background: ${bgColor};
                        padding: 6px 2px;
                        border-radius: 6px;
                        font-size: 11px;
                        cursor: pointer;
                        border: ${isToday ? '2px solid #007AFF' : 'none'};
                        color: white;
                        font-weight: ${isToday ? '600' : '500'};
                    " title="Taken: ${dayStats.taken}, Missed: ${dayStats.missed}">
                        ${day}
                    </div>
                `;
            }
            
            calendarHtml += '</div>';
            
            // Add legend
            calendarHtml += `
                <div style="display: flex; justify-content: center; gap: 12px; margin-top: 12px; font-size: 11px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #34c759; border-radius: 3px;"></div>
                        <span style="color: #86868b;">Good</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #ff9500; border-radius: 3px;"></div>
                        <span style="color: #86868b;">Fair</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 12px; height: 12px; background: #ff3b30; border-radius: 3px;"></div>
                        <span style="color: #86868b;">Poor</span>
                    </div>
                </div>
            `;
            
            document.getElementById('calendarView').innerHTML = calendarHtml;
        }

        // Get medicine statistics for a specific day
        function getDayMedicineStats(medicines, date) {
            let taken = 0;
            let missed = 0;
            
            medicines.forEach(medicine => {
                if (medicine.confirmation_history) {
                    medicine.confirmation_history.forEach(record => {
                        const recordDate = new Date(record.timestamp);
                        if (recordDate.toDateString() === date.toDateString()) {
                            if (record.taken) {
                                taken++;
                            } else {
                                missed++;
                            }
                        }
                    });
                }
            });
            
            const total = taken + missed;
            const adherenceRate = total > 0 ? Math.round((taken / total) * 100) : 0;
            
            return { taken, missed, adherenceRate };
        }

        // Display medicine schedule
        function displayMedicineSchedule(medicines) {
            let html = '';
            
            if (medicines.length === 0) {
                html = '<p style="color: #86868b; text-align: center; padding: 20px;">No medicines scheduled</p>';
            } else {
                medicines.forEach(medicine => {
                    const nextDose = getNextDoseTime(medicine);
                    html += `
                        <div style="
                            background: white;
                            border: 1px solid #e5e5e7;
                            border-left: 4px solid #007AFF;
                            padding: 12px;
                            margin-bottom: 8px;
                            border-radius: 8px;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1d1d1f; font-size: 16px; margin-bottom: 4px;">${medicine.medicine_name}</div>
                                    <div style="font-size: 13px; color: #86868b; line-height: 1.4;">
                                        <div>${medicine.dosage} ‚Ä¢ ${medicine.times.join(', ')}</div>
                                        <div style="margin-top: 2px;">Next: ${nextDose}</div>
                                    </div>
                                </div>
                                <div style="
                                    padding: 4px 8px;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 600;
                                    background: ${isActiveMedicine(medicine) ? '#e8f5e8' : '#f8d7da'};
                                    color: ${isActiveMedicine(medicine) ? '#34c759' : '#ff3b30'};
                                    margin-left: 8px;
                                    white-space: nowrap;
                                ">
                                    ${isActiveMedicine(medicine) ? 'Active' : 'Inactive'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('medicineSchedule').innerHTML = html;
        }

        // Get next dose time
        function getNextDoseTime(medicine) {
            if (!isActiveMedicine(medicine)) return 'N/A';
            
            const now = new Date();
            const today = now.toDateString();
            const times = medicine.times || [];
            
            for (let time of times) {
                const [hours, minutes] = time.split(':').map(Number);
                const doseTime = new Date();
                doseTime.setHours(hours, minutes, 0, 0);
                
                if (doseTime > now && doseTime.toDateString() === today) {
                    return doseTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }
            }
            
            return 'Tomorrow';
        }

        // Check if medicine is active
        function isActiveMedicine(medicine) {
            if (!medicine.active) return false;
            
            const now = new Date();
            const startDate = new Date(medicine.start_date);
            const endDate = new Date(medicine.end_date);
            
            return now >= startDate && now <= endDate;
        }

        // Display recent activity
        function displayRecentActivity(medicines) {
            let activities = [];
            
            medicines.forEach(medicine => {
                if (medicine.confirmation_history) {
                    medicine.confirmation_history.forEach(record => {
                        activities.push({
                            medicine: medicine.medicine_name,
                            ...record,
                            timestamp: new Date(record.timestamp)
                        });
                    });
                }
            });
            
            // Sort by timestamp (most recent first)
            activities.sort((a, b) => b.timestamp - a.timestamp);
            
            // Take only last 10 activities
            activities = activities.slice(0, 10);
            
            let html = '';
            if (activities.length === 0) {
                html = '<p style="color: #666; text-align: center;">No recent activity</p>';
            } else {
                activities.forEach(activity => {
                    const statusColor = activity.taken ? '#28a745' : '#dc3545';
                    const statusText = activity.taken ? '‚úì Taken' : '‚úó Missed';
                    
                    html += `
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 8px 0;
                            border-bottom: 1px solid #eee;
                        ">
                            <div>
                                <strong>${activity.medicine}</strong>
                                <div style="font-size: 12px; color: #666;">
                                    ${activity.timestamp.toLocaleString()}
                                </div>
                            </div>
                            <div style="
                                color: ${statusColor};
                                font-weight: bold;
                                font-size: 12px;
                            ">${statusText}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('recentActivity').innerHTML = html;
        }

        // Refresh elderly details
        function refreshElderlyDetails(elderlyId) {
            loadElderlyDetails(elderlyId);
        }

        // Close elderly details modal
        function closeElderlyDetailsModal() {
            const modal = document.getElementById('elderlyDetailsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show medicine management modal
        function showMedicineModal(elderlyId, elderlyName) {
            const modalHtml = `
                <div id="medicineModal" class="modal-overlay" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div class="modal-content" style="
                        background: white;
                        border-radius: 15px;
                        padding: 30px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üíä Manage Medicines for ${elderlyName}</h3>
                        
                        <div id="medicineList" style="margin-bottom: 20px;">
                            <p>Loading medicines...</p>
                        </div>
                        
                        <h4 style="color: #333; margin-bottom: 15px;">Add New Medicine</h4>
                        <form id="medicineForm" style="display: flex; flex-direction: column; gap: 15px;">
                            <input type="text" id="medicineName" placeholder="Medicine Name" required style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <input type="text" id="dosage" placeholder="Dosage (e.g., 1 tablet, 5ml)" required style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <input type="text" id="times" placeholder="Times (e.g., 09:00, 21:00)" required style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <input type="text" id="instructions" placeholder="Instructions (optional)" style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <input type="date" id="startDate" required style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <input type="date" id="endDate" required style="
                                padding: 12px;
                                border: 2px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 14px;
                            ">
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">Add Medicine</button>
                                <button type="button" onclick="closeMedicineModal()" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 12px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">Close</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            loadMedicinesForElderly(elderlyId);
            
            // Set today's date as default
            document.getElementById('startDate').valueAsDate = new Date();
            
            // Set form submit handler
            document.getElementById('medicineForm').onsubmit = function(e) {
                e.preventDefault();
                addMedicineForElderly(elderlyId);
            };
        }

        // Load medicines for elderly
        async function loadMedicinesForElderly(elderlyId) {
            try {
                const response = await fetch(`${API_BASE}/medicines/${elderlyId}`);
                const data = await response.json();
                const medicines = data.medicines || [];
                
                const listDiv = document.getElementById('medicineList');
                if (medicines.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666;">No medicines scheduled</p>';
                } else {
                    let html = '<h5 style="color: #333; margin-bottom: 10px;">Current Medicines:</h5>';
                    medicines.forEach(medicine => {
                        html += `
                            <div style="
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 10px;
                                border-left: 4px solid #667eea;
                            ">
                                <strong>${medicine.medicine_name}</strong> - ${medicine.dosage}<br>
                                <small style="color: #666;">
                                    Times: ${medicine.times.join(', ')} | 
                                    From: ${medicine.start_date} to ${medicine.end_date}
                                </small>
                                <button onclick="deleteMedicine(${medicine.id}, '${elderlyId}')" style="
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    padding: 5px 10px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    float: right;
                                    font-size: 12px;
                                ">Delete</button>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading medicines:', error);
                document.getElementById('medicineList').innerHTML = '<p style="color: #dc3545;">Error loading medicines</p>';
            }
        }

        // Add medicine for elderly
        async function addMedicineForElderly(elderlyId) {
            const guardianUsername = localStorage.getItem('guardian_username');
            
            const medicineData = {
                guardian_username: guardianUsername,
                elderly_id: elderlyId,
                medicine_name: document.getElementById('medicineName').value,
                dosage: document.getElementById('dosage').value,
                times: document.getElementById('times').value.split(',').map(t => t.trim()),
                instructions: document.getElementById('instructions').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value
            };

            try {
                const response = await fetch(`${API_BASE}/medicine/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medicineData)
                });

                if (response.ok) {
                    alert('Medicine added successfully!');
                    document.getElementById('medicineForm').reset();
                    document.getElementById('startDate').valueAsDate = new Date();
                    loadMedicinesForElderly(elderlyId);
                } else {
                    alert('Error adding medicine');
                }
            } catch (error) {
                console.error('Error adding medicine:', error);
                alert('Error adding medicine');
            }
        }

        // Delete medicine
        async function deleteMedicine(medicineId, elderlyId) {
            if (!confirm('Are you sure you want to delete this medicine?')) return;
            
            const guardianUsername = localStorage.getItem('guardian_username');
            
            try {
                const response = await fetch(`${API_BASE}/medicine/delete/${medicineId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        guardian_username: guardianUsername,
                        elderly_id: elderlyId
                    })
                });

                if (response.ok) {
                    alert('Medicine deleted successfully!');
                    loadMedicinesForElderly(elderlyId);
                } else {
                    alert('Error deleting medicine');
                }
            } catch (error) {
                console.error('Error deleting medicine:', error);
                alert('Error deleting medicine');
            }
        }

        // Submit suggestion
        async function submitSuggestion(elderlyId, suggestion) {
            const guardianUsername = localStorage.getItem('guardian_username');
            
            try {
                const response = await fetch(`${API_BASE}/medicine/suggestions/${elderlyId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        guardian_username: guardianUsername,
                        suggestion: suggestion
                    })
                });

                if (response.ok) {
                    alert('Suggestion added successfully!');
                } else {
                    alert('Error adding suggestion');
                }
            } catch (error) {
                console.error('Error adding suggestion:', error);
                alert('Error adding suggestion');
            }
        }

        // Close medicine modal
        function closeMedicineModal() {
            const modal = document.getElementById('medicineModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show registration instructions
        function showRegistrationInstructions() {
            const instructions = `
To link an elderly member to your account:

1. Ask elderly person to visit: http://localhost:8000/elderly-auth.html
2. They should fill in their personal information
3. They must enter your username and password in Guardian Connection section
4. Once registered, they will appear in your dashboard

Important: The elderly person needs your exact username and password to link to your account.
            `;
            alert(instructions);
        }

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = 'guardian-auth.html';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const guardianUsername = loadGuardianInfo();
            if (guardianUsername) {
                fetchLinkedElderly(guardianUsername);
            }
            
            // PWA Install Prompt
            if ('serviceWorker' in navigator) {
                registerServiceWorker();
            }
            
            // Show install banner if not installed
            showInstallBanner();
        });

        // Register Service Worker
        function registerServiceWorker() {
            const swCode = `
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open('silvercare-v1').then((cache) => {
                            return cache.addAll([
                                '/',
                                '/guardian-dashboard.html',
                                '/elderly-dashboard.html',
                                '/guardian-auth.html',
                                '/elderly-auth.html'
                            ]);
                        })
                    );
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(registration => {
                console.log('Service Worker registered');
            }).catch(error => {
                console.log('Service Worker registration failed');
            });
        }

        // Show Install Banner
        function showInstallBanner() {
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return; // Already installed
            }
            
            // Create install banner
            const banner = document.createElement('div');
            banner.id = 'installBanner';
            banner.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #007AFF, #5ac8fa);
                color: white;
                padding: 16px;
                text-align: center;
                z-index: 1000;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 16px;
            `;
            
            banner.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">üì± Install SilverCare App</div>
                    <div style="font-size: 14px; opacity: 0.9;">Add to home screen for better experience</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="dismissInstallBanner()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 14px;
                        cursor: pointer;
                    ">Later</button>
                    <button onclick="installApp()" style="
                        background: white;
                        color: #007AFF;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Install</button>
                </div>
            `;
            
            document.body.appendChild(banner);
        }

        // Dismiss Install Banner
        function dismissInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.remove();
            }
        }

        // Install App
        function installApp() {
            // For iOS Safari
            if (navigator.userAgent.match(/iPhone|iPad|iPod/)) {
                showIOSInstructions();
            }
            // For Android Chrome
            else if (navigator.userAgent.match(/Android/)) {
                showAndroidInstructions();
            }
            // For others
            else {
                showGenericInstructions();
            }
        }

        // Show iOS Instructions
        function showIOSInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 24px;
                    max-width: 350px;
                    width: 100%;
                    text-align: center;
                ">
                    <h3 style="color: #000; margin-bottom: 16px;">üì± Install SilverCare</h3>
                    <div style="color: #6c6c70; margin-bottom: 20px; line-height: 1.5;">
                        <div style="margin-bottom: 12px;"><strong>Step 1:</strong> Tap the Share button <span style="font-size: 20px;">‚éã</span></div>
                        <div style="margin-bottom: 12px;"><strong>Step 2:</strong> Scroll down and tap "Add to Home Screen"</div>
                        <div><strong>Step 3:</strong> Tap "Add" to install the app</div>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: #007AFF;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 24px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        width: 100%;
                    ">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            dismissInstallBanner();
        }

        // Show Android Instructions
        function showAndroidInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 24px;
                    max-width: 350px;
                    width: 100%;
                    text-align: center;
                ">
                    <h3 style="color: #000; margin-bottom: 16px;">üì± Install SilverCare</h3>
                    <div style="color: #6c6c70; margin-bottom: 20px; line-height: 1.5;">
                        <div style="margin-bottom: 12px;"><strong>Step 1:</strong> Tap the menu button <span style="font-size: 20px;">‚ãÆ</span></div>
                        <div style="margin-bottom: 12px;"><strong>Step 2:</strong> Tap "Add to Home screen" or "Install app"</div>
                        <div><strong>Step 3:</strong> Tap "Install" to add the app</div>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: #007AFF;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 24px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        width: 100%;
                    ">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            dismissInstallBanner();
        }

        // Show Generic Instructions
        function showGenericInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 24px;
                    max-width: 350px;
                    width: 100%;
                    text-align: center;
                ">
                    <h3 style="color: #000; margin-bottom: 16px;">üì± Install SilverCare</h3>
                    <div style="color: #6c6c70; margin-bottom: 20px;">
                        Look for "Add to Home Screen" or "Install App" in your browser menu to install this app.
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: #007AFF;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 24px;
                        font-size: 16px;
                        font-weight: 500;
                        cursor: pointer;
                        width: 100%;
                    ">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            dismissInstallBanner();
        }
    </script>
</body>
</html>
