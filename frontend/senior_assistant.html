<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SilverCare - Assistant</title>
    <link rel="stylesheet" href="senior_styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <button class="back-btn" onclick="window.history.back()">‚Üê</button>
            <h1>Health Assistant</h1>
            <div class="status-indicator">
                <div class="status-dot online"></div>
                <span>Online</span>
            </div>
        </header>

        <!-- Chat Interface -->
        <main class="chat-main">
            <div class="chat-welcome">
                <div class="welcome-icon">üí¨</div>
                <h2>I'm here to help!</h2>
                <p>Ask me anything about your health, medicines, or daily activities</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <p>Hello! I'm your SilverCare health assistant. I can help you with:</p>
                        <ul>
                            <li>Medicine reminders and information</li>
                            <li>Health tips and advice</li>
                            <li>Daily activity suggestions</li>
                            <li>Emergency assistance</li>
                        </ul>
                        <p>How can I help you today?</p>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <button class="quick-btn" onclick="sendQuickMessage('What medicines do I need to take today?')">
                        <span class="btn-icon">üíä</span>
                        <span>Today's Medicines</span>
                    </button>
                    <button class="quick-btn" onclick="sendQuickMessage('How am I feeling today?')">
                        <span class="btn-icon">‚ù§Ô∏è</span>
                        <span>Health Status</span>
                    </button>
                    <button class="quick-btn" onclick="sendQuickMessage('What activities should I do today?')">
                        <span class="btn-icon">üö∂</span>
                        <span>Daily Activities</span>
                    </button>
                    <button class="quick-btn" onclick="sendQuickMessage('I need help')">
                        <span class="btn-icon">üÜò</span>
                        <span>Emergency Help</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Type your message..." 
                    onkeypress="if(event.key==='Enter') sendMessage()"
                    autocomplete="off"
                >
                <button class="send-btn" onclick="sendMessage()" id="sendButton">
                    <span>‚û§</span>
                </button>
            </div>
            <div class="voice-btn" onclick="toggleVoiceInput()" id="voiceBtn">
                <span>üé§</span>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="senior_app.html" class="nav-item">
                <div class="nav-icon">üè†</div>
                <span>Home</span>
            </a>
            <button class="nav-item" onclick="window.location.href='senior_health.html'">
                <div class="nav-icon">‚ù§Ô∏è</div>
                <span>Health</span>
            </button>
            <button class="nav-item" onclick="window.location.href='senior_medicines.html'">
                <div class="nav-icon">üíä</div>
                <span>Medicines</span>
            </button>
            <button class="nav-item active">
                <div class="nav-icon">üí¨</div>
                <span>Assistant</span>
            </button>
        </nav>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let patientId = localStorage.getItem('currentPatientId');
        let isListening = false;
        let recognition = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            initializeVoiceRecognition();
        });

        // Initialize chat
        function initializeChat() {
            // Focus input
            document.getElementById('messageInput').focus();
            
            // Load chat history if needed
            loadChatHistory();
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Send to backend
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Add bot response
                setTimeout(() => {
                    addMessage(data.reply, 'bot');
                }, 500);
                
            } catch (error) {
                removeTypingIndicator();
                addMessage(getFallbackResponse(message), 'bot');
            }
        }

        // Send quick message
        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // Add message to chat
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = `<p>${text}</p>`;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save to history
            saveChatHistory(text, sender);
        }

        // Show typing indicator
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(content);
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Get fallback response
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('medicine') || lowerMessage.includes('medicines')) {
                return "I can help you with your medicines! Based on your schedule, you should check your medicine reminders in the Health section. Would you like me to tell you about your next dose?";
            }
            
            if (lowerMessage.includes('health') || lowerMessage.includes('feeling')) {
                return "Your health status looks good today! Your device is connected and monitoring your vitals. I've noticed you've been active today, which is great for your overall health. Keep up the good work!";
            }
            
            if (lowerMessage.includes('activity') || lowerMessage.includes('exercise')) {
                return "Daily activities are important for your health! I recommend a gentle 15-minute walk, some light stretching, or simple chair exercises. Always listen to your body and don't overdo it. Would you like some specific exercise suggestions?";
            }
            
            if (lowerMessage.includes('help') || lowerMessage.includes('emergency')) {
                return "I'm here to help! If this is an emergency, please use the SOS button on the main screen or call your emergency contact immediately. For non-urgent help, I can assist you with medicines, health tips, or daily activities. What do you need help with?";
            }
            
            if (lowerMessage.includes('sleep') || lowerMessage.includes('tired')) {
                return "Good sleep is essential for your health! Try to maintain a regular sleep schedule, avoid caffeine late in the day, and create a comfortable sleep environment. If you're having trouble sleeping, I can suggest some relaxation techniques.";
            }
            
            if (lowerMessage.includes('water') || lowerMessage.includes('hydrate')) {
                return "Staying hydrated is very important! Try to drink at least 8 glasses of water throughout the day. You can set reminders on your phone or keep a water bottle nearby as a visual reminder.";
            }
            
            // Default responses
            const responses = [
                "I'm here to help you with your health and wellness. What would you like to know about?",
                "I can assist you with medicines, health tips, daily activities, and more. How can I help you today?",
                "Your health and safety are my priority. What's on your mind?",
                "I'm your personal health assistant. Ask me anything about your daily routine or health concerns.",
                "I'm here to support you in your wellness journey. What would you like to discuss?"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Voice recognition
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopVoiceInput();
                };
                
                recognition.onend = function() {
                    stopVoiceInput();
                };
            }
        }

        // Toggle voice input
        function toggleVoiceInput() {
            if (!recognition) {
                alert('Voice recognition is not supported in your browser');
                return;
            }
            
            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            recognition.start();
            isListening = true;
            document.getElementById('voiceBtn').classList.add('listening');
            document.getElementById('voiceBtn').innerHTML = '<span>üî¥</span>';
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
            }
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
            document.getElementById('voiceBtn').innerHTML = '<span>üé§</span>';
        }

        // Chat history
        function saveChatHistory(message, sender) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.push({
                message: message,
                sender: sender,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 messages
            if (history.length > 50) {
                history.splice(0, history.length - 50);
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(history));
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const messagesContainer = document.getElementById('chatMessages');
            
            // Clear existing messages except welcome
            messagesContainer.innerHTML = messagesContainer.innerHTML;
            
            // Load last 10 messages
            history.slice(-10).forEach(item => {
                addMessage(item.message, item.sender);
            });
        }

        // Add chat-specific styles
        const chatStyles = `
            .chat-main {
                flex: 1;
                padding: 20px;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
            }
            
            .chat-welcome {
                text-align: center;
                padding: 40px 20px;
                background: linear-gradient(135deg, #f8f9ff 0%, #e0e7ff 100%);
                border-radius: 20px;
                margin-bottom: 20px;
            }
            
            .welcome-icon {
                font-size: 4rem;
                margin-bottom: 20px;
            }
            
            .chat-welcome h2 {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-dark);
                margin-bottom: 10px;
            }
            
            .chat-welcome p {
                color: var(--text-gray);
                font-size: 1rem;
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 10px 0;
            }
            
            .message {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                animation: fadeIn 0.3s ease;
            }
            
            .message.user {
                flex-direction: row-reverse;
            }
            
            .message-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
                flex-shrink: 0;
            }
            
            .user .message-avatar {
                background: var(--gradient-blue);
                color: white;
            }
            
            .bot .message-avatar {
                background: var(--gradient-green);
                color: white;
            }
            
            .message-content {
                max-width: 70%;
                padding: 15px;
                border-radius: 18px;
                position: relative;
            }
            
            .user .message-content {
                background: var(--gradient-blue);
                color: white;
                border-bottom-right-radius: 6px;
            }
            
            .bot .message-content {
                background: white;
                color: var(--text-dark);
                border: 2px solid var(--border-color);
                border-bottom-left-radius: 6px;
            }
            
            .message-content p {
                margin: 0;
                line-height: 1.4;
            }
            
            .message-content ul {
                margin: 10px 0;
                padding-left: 20px;
            }
            
            .message-content li {
                margin-bottom: 5px;
            }
            
            .typing-dots {
                display: flex;
                gap: 4px;
                padding: 10px 0;
            }
            
            .typing-dots span {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--text-gray);
                animation: typing 1.4s infinite;
            }
            
            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            
            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }
            
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-10px); }
            }
            
            .quick-actions {
                background: white;
                border-radius: 20px;
                padding: 20px;
                border: 2px solid var(--border-color);
                margin-bottom: 20px;
            }
            
            .quick-actions h3 {
                font-size: 1.2rem;
                font-weight: 700;
                color: var(--text-dark);
                margin-bottom: 15px;
                text-align: center;
            }
            
            .action-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .quick-btn {
                background: var(--bg-gray);
                border: 2px solid var(--border-color);
                border-radius: 12px;
                padding: 15px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .quick-btn:hover {
                background: var(--gradient-blue);
                color: white;
                border-color: var(--primary-blue);
                transform: translateY(-2px);
            }
            
            .btn-icon {
                font-size: 1.5rem;
            }
            
            .btn-text {
                font-size: 0.9rem;
                font-weight: 600;
                text-align: center;
            }
            
            .chat-input-container {
                padding: 20px;
                background: white;
                border-top: 2px solid var(--border-color);
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .input-wrapper {
                flex: 1;
                display: flex;
                gap: 10px;
                align-items: center;
                background: var(--bg-gray);
                border-radius: 25px;
                padding: 5px;
                border: 2px solid var(--border-color);
            }
            
            .input-wrapper:focus-within {
                border-color: var(--primary-blue);
            }
            
            #messageInput {
                flex: 1;
                border: none;
                background: transparent;
                padding: 12px 15px;
                font-size: 1rem;
                outline: none;
            }
            
            .send-btn {
                background: var(--gradient-blue);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .send-btn:hover {
                transform: scale(1.1);
            }
            
            .voice-btn {
                background: var(--bg-gray);
                border: 2px solid var(--border-color);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .voice-btn:hover {
                background: var(--gradient-green);
                color: white;
                border-color: var(--primary-green);
            }
            
            .voice-btn.listening {
                background: var(--gradient-red);
                color: white;
                border-color: var(--primary-red);
                animation: pulse 1s infinite;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            `;
        
        // Inject styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = chatStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
